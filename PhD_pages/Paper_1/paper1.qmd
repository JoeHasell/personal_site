---
title: "Paper 1: Triangulating trends in inequality around the world from secondary databases"
format: html
bibliography: references_export_2023-04-04.bib
execute:
  echo: false
  warning: false
---

::: {.callout-note collapse="true" appearance="minimal"}
### Load packages and data

```{python}

from plotnine import *
import plotly.express as px
import pandas as pd
import numpy as np
# from IPython.display import display, HTML, IFrame, Markdown
# import dataframe_image as dfi
# import imgkit

from data_appendix.G_functions_for_figures_and_tables import * 

# pd.set_option('display.max_rows', None)

```


```{python}

fp = 'data_appendix/data/clean/pip.csv'
        
df_pip = pd.read_csv(fp)


fp = 'data_appendix/data/clean/wid.csv'

df_wid = pd.read_csv(fp)

fp = 'data_appendix/data/clean/lis.csv'

df_lis = pd.read_csv(fp)


fp = 'data_appendix/data/clean/region_mapping.csv'

df_regions = pd.read_csv(fp)


fp = 'data_appendix/data/clean/population.csv'

df_pop = pd.read_csv(fp)

fp = 'data_appendix/data/clean/region_population.csv'

df_pop_regions = pd.read_csv(fp)


# Gather data into dictionary
source_dfs = {
    "PIP": df_pip,
    "WID": df_wid,
    "LIS": df_lis
    }


# This specifies the +/- for the 'stable' category in the tables below
tolerance_lookup =  {
                'var_search_term': [
                    'Gini',
                    'Top 1pc share', 
                    'Top 10pc share',
                    'Bottom 50pc share'],
                'var_tolerance': [
                    1,
                    1,
                    1,
                    1
                ], 
                'relative_tolerance': [
                    0.05
                ]
            }

```


```{python}
def make_selection_msg(reference_vals,max_dist_from_refs,all_metrics_requirement,selected_vars):
    msg = f'{reference_vals[0]} vs {reference_vals[1]} (+/- {max_dist_from_refs} years)'

    if len(selected_vars)>1:
        if all_metrics_requirement:
            msg = f'{msg} – Matched countries only'
        else:
            msg = f'{msg} – All available countries' 

    return(msg)

```

:::

READING LIST:
Bourguignon (2015)
The share of wages in total GDP declined in a majority of countries
(91 out of 133 with data) from 1995 to 2014 (ILO, 2016).

 Other authors
question the pre-eminence of globalization as the main driver of global inequality, noting
that inequality trends differ across countries at similar levels of development and that
are equally exposed to trade (Ravallion, 2018; Corlett, 2016). Ravallion (2018) stresses
the vital role that natio

Key point:  the share of income going to both the top 1 per cent and the bottom 50 per
cent has increased in many countries in recent decades. 


In 2021, while the very richest individuals buy trips to space, roughly three billion people are unable to afford a healthy diet. Even  rich countries secured COVID vaccines for their entire population, low-income had barely begun. COVID vaccination rates  at all, the richest countries had already administered more than one dose for every citizen.

Such 



"Inequality defines our time," states the UN Secretary-General.^[United Nations Secretary-General António Guterres made the comment in the 18th Nelson Mandela Annual Lecture in July 2020. See https://www.nelsonmandela.org/news/entry/annual-lecture-2020-secretary-general-guterress-full-speech.]


Just as the demand for data to monitor inequality globally is greater than ever, so is its supply.

In part, this increased concern is a reflection of events - of the severe and uneven impacts of the 2007-8 Global Financial Crisis, the COVID-19 pandemic and recent sharp rises in the cost of living.


# Introduction

Economic inequalities around the world are enormous. As the very richest individuals buy trips to space, roughly three billion people are unable to afford a healthy diet. 

Such stark disparities have gained more attention in recent decades, among policimakers, academics and the public alike. "Inequality defines our time," according to the UN Secretary-General.^[United Nations Secretary-General António Guterres made the comment in the 18th Nelson Mandela Annual Lecture in July 2020. See https://www.nelsonmandela.org/news/entry/annual-lecture-2020-secretary-general-guterress-full-speech.]

In part at least, this increased concern reflects an increase in the *availability* of distributional data. New and expanded sources of data have shed new light on extent of inequality around the world and how it is changing. This has enabled concerns about high or rising inequality to be expressed in new ways, formulated more precisely and subsequently monitored. The supply and demand for global data on inequality have been mutually reinforcing.

Two sources of data have been particularly impactful in this regard. One is the World Bank's harmonized collection of household survey data, published online through its [*Poverty and Inequality Platform (PIP)*](https://pip.worldbank.org/). Another is the collection of inequality estimates, most notably top income shares, brought together at the [*World Inequality Database (WID)*](https://wid.world/).^[TODO: PIP used to be Povcal. It draws upon the work of various regional teams. WID used to be WTID.]

These two sources are the only regularly-updated databases that provide global coverage of distributional data on a relatively comparable basis.^[EDIT: Both datasets suffer important limitations with respect to comparability acrosss time and location. These will be discussed in the data section below. Both datasets, however, take significant steps to harmonize, *ex-post*, the available underlying data. In this respect they can be distinguished from databases such as WIID and SWIID [@atkinson_promise_2001]]

Both have played substantial agenda-setting roles in academic research, policy and public debate.

The World Bank data is especially prominent within international development policy, notably being used to monitor many of the UN Sustainable Development Goals. Academic research on global inequality has also largely relied on this data  [@Kanbur2022-lk; @lakner_global_2016; @anand_global_2015; @Nino-Zarazua2017-tv; @Ravallion2014-mk]. *[TODO: Check and more refs.]*.

The WID database emerged along with the burgeoning literature on top incomes, acting as a central repository and, increasingly, coordinating institution. The 1%




## Two worlds of inequality measurement

As well as being the the two  not just two different databases. They in some sense represent *two different worlds* of inequality measurement.

Different methods. These yield different pictures of the extent of inequality and how it has changed over time. Motivated by different ideas about the salient factors shaping inequality.

### PIP



### WID


They differ as to how ubiquitous a phenomenon rising inequality is around the world. The view from *World Inequality Database* and its associated global report is that inequality is rising in 'nearly everywhere' [@alvaredo_world_2018; @chancel_world_2021].[^WID_quotes] In contrast, the World Bank data and its biannual report offers a much more mixed picture – in which inequality is rising and falling in roughly equal numbers of countries.


[^WID_quotes]:
    > Income and wealth inequalities have been on the rise nearly everywhere since the 1980s, following a series of deregulation and liberalization programs which took different forms in different countries. [@chancel_world_2021, pp. xx]

    > In recent decades, income inequality has increased in nearly all countries, but at different speeds... [@alvaredo_world_2018, pp. xx]


Decompositions of global inequality into between- and within-country components. 

Capital vs labour share. .– including fundamental laws of capitalism with regard to capital accumulation (Piketty) – 


### The disconnect between these datasets devaules them both

There remains fundamental ambiguity surrounding which of two possible worlds we live in. 

The '*WID* world' rising inequality within countries has been an almost universal phenomenon. suggests the winners from globalization and economic growth overwhelmingly have been a global elite. It sees the bulk of global inequalities as lying within nations, but emphasises global factors in terms of causes and hence the need for international coordination to combat inequality.

The '*PIP* world' – within-country inequality trends in recent decades have been mixed, and the differences in average incomes between countries remain the lion's share of the globally.As such the importance of national policy (Ravallion, 2018; Corlett, 2016). access to both produced and human capital.

Knowing which of these worlds we live in matters a great deal – for our understanding of inequality today, how it has changed, and also where efforts to combat inequality in the future are likely to be most successful.

Trouble is that these are all bundled up. You must chose. On what basis can you make a choice?

Known problems on both sides.

For PIP – top incomes, and lack of comparability of the survey data – notably mix of incme and consumption data.

For WID – tha many assumptions. An emphasis placed on the incorporation of tax data, but when taking a global view confonte by the fact that such tax data is often nonexistent. Top income corrections based on strong assumptions.

Given the presentation, the extent to which different assumptions, indices, methodological choices affects the data and – is not something that can be read off' the data.

In using the datasets a global view on inequality, requires choosing wholesale between methodological 'bundles' whose relative strengths and weaknesses, applied globally, are not well understood.

Also makes for a very confusing terrain for policymakers, media and the public.

The two datasets are incredible efforts, involving the work of hundreds of researchers. Both datasets have continued to improve adn expand. In terms of data availability we are thus in a better position than ever to take a global viw on inequlity. And yet, amidst this wealth of data, limited understanding of very basics concerning inequality around the world.



### Outline: Connecting the two worlds
*(In this section I will explain the plan for the paper)*

In this paper I aim to bring these two worlds of inequality measurement closer. To Triangulate what they do agree on and identify where they disagree.

The first, most obvious, step is simply to compare the in a systemtatic way. This very basic step is curiously lacking in the literature. We begin by comparing trends in each world based on the inequality indices most typical in each: the Gini coefficient for the PIP data, and the top 1% share of pre-tax income for WID.

Given incomplete coverage in both datasets, we 'line up' estimates to reference years to see change over time. We use two periods, presenting two different tradeoffs with respect to data coverage. The first is 1993-2018?? This maximises global coverage – 100 countries covering roughly 90% of the world poplation (Figure XX). The downside is that this period misses out – transition, liberalisation and structural adjustment. Question begging, by avoiding specifically the period where inequality thought to rise.

The second is 1980-2018. Here we lose coverage, especially in the PIP data (Figure XX).

The two measures selected – Gini coefficient of disposable income/consumption, and the top 1% share of pre-tax income – are where the PIP and WID worlds respectively are at their furthest apart. Yet in terms of broad global trends, there is much that even these very different measures can agree on: - x, - y, - z.

There are big differences though:
- Somewhat more pronounced rise among advanced economies.
- Big divergence in trend some of the most populous countries

The rest of the paper is about understanding where those differences emerge.

- Inequality indices chosen. We align. Compare Top 1%. And Gini.
    - Explain results.

- We look at different income concepts for the small number of coutnries for which such data exists. To this end we also include data from the Luxembourg Income Study. Similar to PIP in that it relies on survey data. But provides access to microdata, allowing for the construction of different welfare aggregates. We focus on the countries with the biggest difference in trend and biggest population. I.e. those that contribute most to the difference in the weighted an unweigted global averages.


    What I won't do is a detailed lining up.
    Although both institutions continue to take many steps to provide transparency and reproducibility to their estimates, they remain a black box. Makes it impossible to do this lining up. 
    In many particular contexts – where detailed lining up is possible – there relative strengths and weaknesses may be clear. (This is what Morllei does. And Nolan). But at the global level the makes this impractical. 

    - Summarise: really depends on the country.

----


# 2. Comparing the two worlds


What we're trying to do with triangulation is see whether they show a qualitively similar picture of whether, and how rapidly, inequality was rising or falling.

But what would 'similar' be for Gini and top 1. Not a 1 point move.

The main way of operationalising 'similar' is to look at Relative change: a percentage, rather than percentage point. We can put some threshold and see if there were rises or falls. 

Possibly a footnote: No reason to expect this given the properties of the two measures. If we take lognormality we see... (MAke a chart in appendix - where we plot Gini against top 10 and top 1% assuming lognormality, and then add actual data for a particular country.) How unlognormal the top is would be another way to judge similarity. Rather than doing this, we bridge by aligning the indices.

- We also do absolute change: a percentage point. This is more intuitive. But somewhat arbitrary – differences in levels affect assessment of differences in trends. (Or possibly empahasise this measure if there is little difference to the relative threshold.)


- A third way is residuals from a regression of the two measures
    - This we will use to see countries that are particular outliers.

To get an overview: I'll use the unweigted and population weighted average. The first represents change in inequality in the average country. 

All broken down by region.



## Inequality since 1993

In @fig-pip-wid-1993-2015-all-obs we plot the level of inequality in 1993 and 2015 against each other, using the inequality measures 'typical' of each dataset.

To help with the interpretation, a band is shown along the 45-degree line. Countries falling within this band saw little change in inequality. Countries falling above it saw a substantive rise in inequality between the two periods. Countries falling below it saw a substantive fall. 'Substantive' here is defined as a change of more than 2 percentage points in the case of the PIP Gini coefficient, and more than 1 percentage point in the case of the WID top 1% share.


From the visual inspection, in conjunction with @tbl-pip-wid-1993-2015-all-obs-averages.  In both sets of data, we see a mix of countries with rising and falling inequality. In the case of WID top 1% share, far more rises than falls. In both we see some convergence – . This is largely driven by regional dynamics. 

This is confirmed in summary tables.  and this ...
Tolerance: different thresholds due to different range of data. In the appendix we consider relative thresholds (+/-5%), which makes little difference.

@tbl-pip-wid-1993-2015-all-obs-absolute-count and @tbl-pip-wid-1993-2015-matching-obs-absolute-count do this...



Considering all available observations in each dataset, we see: 
- 
-
- Much bigger rise in the weigted average in WID.


Whilst the number of countries available in the two datasets is very similar, they are not the same countries. In particular, LAC is largely absent from WID. (Footnote about LAC in WID?? Are the global results based on linear interpolation?... An interpolation that contradicts the survey data?) Also fewer Sub-Saharan African countries. In PIP, fewer rich countries in Western Europe and its offshoots.

Importantly, ... are not neutral with respect to.The regions where WID is lacking coverage – LAC and SSA – are regions in which inequality was generally falling, according to the PIP Gini coefficient. The reverse is also the case: Regions that PIP are lacking – high income countries in W. Europe and offshoots – were regions where inequality was generally rising, according to the WID top 1% shares data.

As such, differences in coverage already go some way to explaining the differences between the two datasets. 
@fig-pip-wid-1993-2015-matching-obs and @tbl-pip-wid-1993-2015-matching-obs-averages show the data, restricting the observations to those available in both datasets. This brings the two series closer. Explain. (Coverage falls)

It is worth emphasising the similarities:
-
-
-

Nevertheless, there are clearly differences in what – even after aligning coverage. Are these about the metric, or other methodological differences? WE will see later on.




```{python}
# Set-up to compare WID and PIP top 10% share, all observations
reference_vals = [1993, 2015]
max_dist_from_refs = 3


selected_vars = [
        'PIP: Gini',
        'WID: Top 1pc share – pretax'
        ]

output_dict = prep_data_and_change_summary(
      source_dfs = source_dfs,
      df_pop = df_pop,
      df_pop_regions = df_pop_regions,
      df_regions = df_regions,
      region_col = 'region',
      selected_vars = selected_vars,
      reference_vals = reference_vals,
      max_dist_from_refs = max_dist_from_refs,
      min_dist_between = 1,
      reference_col = "Year",
      group_by_col = "Entity",
      outlier_cut_off_upper = None,
      tolerance_lookup =  tolerance_lookup
      )

# Store data for OWID upload – prepared further in appendix below
df_owid_1993_2015 = output_dict['owid_format']

fp = 'data_appendix/figures_and_tables/Compare WID and PIP inequality data 1993 vs 2015 (Joe temp).csv'

df_owid_1993_2015.to_csv(fp, index=False)

```



#### Figures 1-2

::: {.panel-tabset}
## All available observations

![PIP Gini and WID Top 1% shahre in 1993 vs 21015 – All available observations](images/figures/PIPGini-vs-WIDTop1-1993-vs-2015-01.png){#fig-pip-wid-1993-2015-all-obs}

## Only observations available in both datasets
![PIP Gini and WID Top 1% shahre in 1993 vs 21015 – Matching observations only](images/figures/PIPGini-vs-WIDTop1-1993-vs-2015-02.png){#fig-pip-wid-1993-2015-matching-obs}

:::




#### Tables 1-2
::: {.panel-tabset}
## All available observations


```{python}
#| label: tbl-pip-wid-1993-2015-all-obs-absolute-count
#| tbl-cap: Change in inequality 1993 vs 2015 - All availalbe observations
output_dict['all_sources_False']['absolute_counts']

```

## Only observations available in both datasets

```{python}
#| label: tbl-pip-wid-1993-2015-matching-obs-absolute-count
#| tbl-cap: Change in inequality 1993 vs 2015 - Matching observations only
output_dict['all_sources_True']['absolute_counts']

```

:::



#### Tables 3-4

::: {.panel-tabset}
## All available observations


```{python}
#| label: tbl-pip-wid-1993-2015-all-obs-averages
#| tbl-cap: Unweighted and weighted average in 1993 vs 2015 - All availalbe observations
output_dict['all_sources_False']['averages']

```

## Only observations available in both datasets

```{python}
#| label: tbl-pip-wid-1993-2015-matching-obs-averages
#| tbl-cap: Unweighted and weighted average in 1993 vs 2015 – Matching observations only
output_dict['all_sources_True']['averages']

```

:::


```{=html}
<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<a href="data_appendix/figures_and_tables/PIP: Gini vs WID: Top 1pc share – pretax – 1993 to 2015 – allObsFalse.csv" download="Gini_vs_Top1_1993_2015.csv">
<!-- Auto width -->
<button class="btn"><i class="fa fa-download"></i> Download full data</button>
</a>
```

#### Figures 1-4



```{=html}

<html>
<body>

<input type="radio" name="1993-vs-2015_radio" value="PIP" checked="checked" onclick="chartSwitchFunction1993_2015_img()">&nbsp;PIP: Gini coefficient
&nbsp;
&nbsp;
<input type="radio" name="1993-vs-2015_radio" value="WID" onclick="chartSwitchFunction1993_2015_img()">&nbsp;WID: Top 1% share

<br>
<label for="1993-vs-2015_radio_obsCheck">Show only observations available in both datasets:</label> 
<input type="checkbox" id="1993-vs-2015_radio_obsCheck" onclick="chartSwitchFunction1993_2015_img()">


<img src="images/figures/pip-gini-1993-vs-2015-all-obs.png" id="1993-vs-2015_plot" width="500">
<br>

</body>
<script>
function chartSwitchFunction1993_2015_img() {

  var ele = document.getElementsByName('1993-vs-2015_radio');


  var checkBox = document.getElementById("1993-vs-2015_radio_obsCheck");

  if (checkBox.checked == true){
    if(ele[0].checked)
        document.getElementById("1993-vs-2015_plot").src = "images/figures/pip-gini-1993-vs-2015-matching-obs.png";

    if(ele[1].checked)
        document.getElementById("1993-vs-2015_plot").src = "images/figures/wid-top-1-1993-vs-2015-matching-obs.png";

  } else {

        if(ele[0].checked)
        document.getElementById("1993-vs-2015_plot").src = "images/figures/pip-gini-1993-vs-2015-all-obs.png";

    if(ele[1].checked)
        document.getElementById("1993-vs-2015_plot").src = "images/figures/wid-top-1-1993-vs-2015-all-obs.png";
  }
}
   
</script>
</html>

    
```




```{python}
output_dict['all_sources_False']['owid_format']

# prepped_data_dict['prepped_data']

# id_vars_duplicates = df[df.duplicated(subset=['source_var', 'Entity'])]

# id_vars_duplicates
```

```{python}
output_dict['all_sources_False']['prepped_data']

```



- Averages + pop coverage

- Country changes (also see which countries strongly disagree in terms of direction)



## Inequality since 1980

```{python}
# Set-up to compare WID and PIP top 10% share, all observations
reference_vals = [1980, 2018]
max_dist_from_refs = 5


selected_vars = [
        'PIP: Gini',
        'WID: Top 1pc share – pretax'
        ]

output_dict = prep_data_and_change_summary(
      source_dfs = source_dfs,
      df_pop = df_pop,
      df_pop_regions = df_pop_regions,
      df_regions = df_regions,
      region_col = 'region',
      selected_vars = selected_vars,
      reference_vals = reference_vals,
      max_dist_from_refs = max_dist_from_refs,
      min_dist_between = 1,
      reference_col = "Year",
      group_by_col = "Entity",
      outlier_cut_off_upper = None,
      tolerance_lookup =  tolerance_lookup
      )

# Store data for OWID upload – prepared further in appendix below
df_owid_1980_2018 = output_dict['owid_format']

fp = 'data_appendix/figures_and_tables/Compare WID and PIP inequality data 1980 vs 2018 (Joe temp).csv'

df_owid_1980_2018.to_csv(fp, index=False)

```



#### Figures X-Y



```{=html}

<html>
<body>

<input type="radio" name="1980_2018_radio" value="PIP" checked="checked" onclick="chartSwitchFunction1980_2018()">&nbsp;PIP: Gini coefficient
&nbsp;
&nbsp;
<input type="radio" name="1980_2018_radio" value="WID" onclick="chartSwitchFunction1980_2018()">&nbsp;WID: Top 1% share

<br>
<label for="obsCheck">Show only observations available in both datasets:</label> 
<input type="checkbox" id="obsCheck" onclick="chartSwitchFunction1980_2018()">

<iframe id="1980_2018_plot" src="https://ourworldindata.org/grapher/pip-gini-1980-vs-2018-all-obs" loading="lazy" style="width: 100%; height: 600px; border: 0px none;"></iframe>;


</body>
<script>
function chartSwitchFunction1980_2018() {

  var ele = document.getElementsByName('1980_2018_radio');


  var checkBox = document.getElementById("obsCheck");

  if (checkBox.checked == true){
    if(ele[0].checked)
        document.getElementById("1980_2018_plot").src = "https://ourworldindata.org/grapher/pip-gini-1980-vs-2018-matching-obs";

    if(ele[1].checked)
        document.getElementById("1980_2018_plot").src = "https://ourworldindata.org/grapher/wid-top-1-1980-vs-2018-matching-obs";

  } else {

        if(ele[0].checked)
        document.getElementById("1980_2018_plot").src = "https://ourworldindata.org/grapher/pip-gini-1980-vs-2018-all-obs";

    if(ele[1].checked)
        document.getElementById("1980_2018_plot").src = "https://ourworldindata.org/grapher/wid-top-1-1980-vs-2018-all-obs";
  }
}
   
</script>
</html>

    
```




# 3. Aligning indices

- Show that measure doesn't matter for WID until top 1 (check Palma ratio)

- Check out how much different metrics matter for PIP.

- Do a 1% vs 1% comparison

- Do a Gini vs Gini comparison

All for 1993 and 1980.



Does it make a difference whether we look at Gini or top 10%?

People worry about whether Gini masks what's happening at the top.

Empirically: 
    - Make a linear model of top 10% on Gini, for each source separately
    - Make predicted top 10%
    - Take a look at the R2
    - Investigate individual countries with very poor predictions

Sub-Saharan Africa: example where the Gini fell in more cases than the top 10%.


# Bridging the gap for particular countries





-----

### Aligning coverage 








## Global data on inequality

### Global databases

A global view faces the hard limitation of the underlying data. This has two sides: firstly is there any data? Secondly the comparability of the data, across countries and over time.

Much improved – *harmonized* secondary databases. Three of note.

- PIP

- WID

- LIS



### Two worlds of inequality measurement



#### Connecting up the worlds is valuable

- for Policy
- for academic research


## Triangulating a global view


### Since 1990



### Since 1980




### Comparing metrics



### Since 1990


Similarities:

Convergence – Smaller rises in coutries that started out with high inequality. Driven regionally. (We could do a test for this.)

Indeed for some regions very similar picture:

    - MENA - Roughly 2 point fall, both Gini and top 10%. Only one country with a rise: Not total agreeement on coverage (one country either side)

    - South and South East Asia – Very similar not weighting by population. But wildly different when weighting by population, due to the much much stronger rise

    -  Sub-Saharan Afric – Very similar across sources. Top 10: Roughly even mix of rises and falling countries, but with a 3 point fall on average. Gini: More falls, 5 point on average. (Mention data quality issues: e.g. Kenya big fall. Lesoto big fall. But how comparable are the surveys?? Same surveys underlie WID...)

    - Western Europe – Rises in a majority of countries, but relatively moderate of 1-2 points (Whether Gini of top 10).


Differences:

Verry different bottom line at the global level:

- PIP: roughly equal numbers falling and rising. 0 average change – though a modest rise when pop weighted (2 points). Same whether Gini or Top 10. That's without LAtin America (Which WID is missing). Includung LatAm tips nudges it (with about a 1 point fall unweighter and 1 point rise weighted)

- WID: Far more countries with rising inequality. On average a 3 point rise (whether top 10 or Gini) – [Better to express these relative to the level of ineq. i.e. % increase rather than % point increase? A point rise means 'less' in WID terms because inequality levels are much higher.] But the most stark difference comes when we weight by population. Some key populous countries: India, China, US?, Indonesia? Russia 

That difference is driven by particular regions:
- 


More countries with rises. LArger rises. Especially larger populations. Average view very different:





Countries where the sources paint a radically different picture that affect the aggregate results:

- India: Insane rise in WID 34->56
- China:
- Russia: Massive drop in PIP. Insane rise in WID.
- USA: Much larger rise in WID.

What explains the different trends in these countries? (We can maybe look in more detail, at different welfare concepts etc.)

It sometimes goes the other way: Indonesia – Rise in PIP, fall in WID.

:::

#### Method 2: Use a regression to obtain the time trend



### Results for a range of inequality metrics


::: {.callout-note collapse="true" appearance="minimal"} 
## Calculations for comparisons



## Explaining differences between PIP and WID data

### For a subset of countries we can bridge between the PIP and WID data

Besides the underlying data sources, there are many differences between what is being measured in the PIP and WID data - notably the welfare concept and unit of analysis/equivalization.

In order to get a better understanding of where differences between the datasets arise, for a subset of countries we can bridge between the two somewhat. For example:

-   WID has post-tax income series for some countries
-   We can use LIS to look at how changing the welfare concept, unit of analysis, equivalisation affects things. (For equivalisation, we could also possibly use the newly available PIP harmonized microdata).

### More in-depth discussion of particular outliers

-   Russia is a very notable case where the two datasets tell very different stories.

# Conclusion



# Appendix
```{python}



# df_owid = pd.concat([df_owid_1993_2015,df_owid_1980_2018])




```




```{python}
# Prep data to upload to OWID for charts

# owid_upload_year_values = {}
# owid_upload_change = {}


# reference_vals = [1993, 2015]
# max_dist_from_refs = 3

# for all_metrics_requirement in [False, True]:

#     prepped_data = prep_data(
#           source_dfs = source_dfs,
#           df_pop = df_pop,
#           df_regions = df_regions,
#           region_col = 'region',
#           selected_vars = selected_vars,
#           reference_vals = reference_vals,
#           max_dist_from_refs = max_dist_from_refs,
#           min_dist_between = 1,
#           all_metrics_requirement = all_metrics_requirement,
#           reference_col = 'Year',
#           group_by_col = 'Entity',
#           tolerance_lookup = tolerance_lookup,
#           outlier_cut_off_upper = None
#           )

#     keep_cols1 = [
#         'source_var', 
#         'Entity',
#         f'Year{reference_vals[0]}', 
#         f'value{reference_vals[0]}', 
#         f'Year{reference_vals[1]}', 
#         f'value{reference_vals[1]}',
#         'region']

#     keep_cols2 = [
#         'source_var', 
#         'Entity',
#         f'Year{reference_vals[0]}', 
#         f'value{reference_vals[0]}', 
#         f'Year{reference_vals[1]}', 
#         f'value{reference_vals[1]}',
#         'region']

#     year_values = prepped_data[keep_cols1]

   
#     year_values = year_values.pivot_table(
#         index=['Entity', 'region'], 
#         columns='source_var',
#         values=[
#             f'Year{reference_vals[0]}', 
#             f'value{reference_vals[0]}', 
#             f'Year{reference_vals[1]}', 
#             f'value{reference_vals[1]}'
#         ]).reset_index()

#     year_values.columns = ['_'.join([str(col) for col in cols]) for cols in year_values.columns]

#     year_values = year_values.rename(columns={
#         "Entity_": "Entity", 
#         "region_": "region"})

#     year_values = pd.melt(
#         year_values, 
#         id_vars=['Entity', 'region'], 
#         value_vars=[
#             f'Year{reference_vals[0]}_{selected_vars[0]}',
#             f'Year{reference_vals[1]}_{selected_vars[0]}',
#             f'value{reference_vals[0]}_{selected_vars[0]}',
#             f'value{reference_vals[1]}_{selected_vars[0]}',
#             f'Year{reference_vals[0]}_{selected_vars[1]}',
#             f'Year{reference_vals[1]}_{selected_vars[1]}',
#             f'value{reference_vals[0]}_{selected_vars[1]}',
#             f'value{reference_vals[1]}_{selected_vars[1]}'
#         ])

#     year_values[['var', 'source_var']] = year_values['variable'].str.split('_', expand=True)
#     # Extract year and group information from variable column
#     year_values[['var', 'reference']] = year_values['var'].str.extract(r'(\D+)(\d+)$')
#     # owid_format['reference'] = owid_format['reference'].astype(int)

#     #Reshape from long to wide
#     year_values=pd.pivot(year_values, index=['Entity', 'region', 'reference' ], columns = ['var','source_var'] ,values = 'value').reset_index() 


#     owid_upload_year_values[f'compare_{reference_vals[0]}_{reference_vals[1]}_allObs{all_metrics_requirement}'] = year_values

    # change_values = prepped_data[keep_cols2]

    # owid_upload_change[f'compare_{reference_vals[0]}_{reference_vals[1]}_allObs{all_metrics_requirement}'] = change_values


# df_owid_year_values = pd.merge(
#     owid_upload_year_values[f'compare_{reference_vals[0]}_{reference_vals[1]}_allObsFalse'],
#     owid_upload_year_values[f'compare_{reference_vals[0]}_{reference_vals[1]}_allObsTrue'],
#     on=['Entity', reference_col, region_col], how='outer', suffixes=(' – all observations', ' – only matching observations'))

# df_owid = owid_upload_year_values[f'compare_{reference_vals[0]}_{reference_vals[1]}_allObsFalse']
# # df_owid = pd.merge(df_owid_1993_2015,df_owid_1980_2018, on=[group_by_col, reference_col, region_col], how='outer', suffixes=(' – all observations', ' – only matching observations'))


# # df_owid = pd.concat([df_owid_1993_2015,df_owid_1980_2018])

# fp = 'data_appendix/figures_and_tables/Compare WID and PIP inequality data (Joe temp).csv'

# df_owid.to_csv(fp, index=False)


```

```{python}
#  # Reshape the data for OWID upload

#     year_values = pd.melt(prepped_data, id_vars=['source_var', 'Entity', 'region' ], value_vars=[f'Year{reference_vals[0]}', f'Year{reference_vals[1]}', f'value{reference_vals[0]}', f'value{reference_vals[1]}'])

#     # Extract year and group information from variable column
#     year_values[['var', 'reference']] = year_values['variable'].str.extract(r'(\D+)(\d+)$')

#     year_values['reference'] = year_values['reference'].astype(int)

#     #Reshape from long to wide
#     year_values=pd.pivot(year_values, index=['source_var', 'Entity', 'region', 'reference' ], columns = 'var' ,values = 'value').reset_index() 

#     # Drop the original reference column
#     year_values = year_values.drop('reference', axis=1)

#     # Pivot the melted dataframe wider – one value column per source_var
#     owid_format = owid_format.pivot_table(index=[group_by_col, region_col, reference_col], columns='source_var', values='value').reset_index()

#     summaries_dict['owid_format'] = owid_format

#     output_dict[f'all_sources_{all_metrics_requirement}'] = summaries_dict
    

#     # Merge the all_sources- True and False data for OWID format
#     owid_format = pd.merge(output_dict['all_sources_False']['owid_format'], output_dict['all_sources_True']['owid_format'], on=[group_by_col, reference_col, region_col], how='outer', suffixes=(' – all observations', ' – only matching observations'))

#     owid_format = owid_format.rename(columns={group_by_col: "country", reference_col: "year"})
    
#     # Reorder columns
#     cols = list(owid_format.columns) # Get the list of column names
#     cols.remove('country') # Remove col1 from the list
#     cols.remove('year') # Remove col2 from the list
#     cols = ['country', 'year'] + cols # Add col1 and col2 to the front of the list
#     owid_format = owid_format[cols] # Reorder columns in the DataFrame
    
#     owid_format['year'] = owid_format['year'].astype(int) # Year needs to be integer for OWID

```

## Data coverage



## PIP Gini vs WID Top 1% share

### 1993-2015
